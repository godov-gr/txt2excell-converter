import sys
from PyQt6.QtWidgets import (
    QApplication, QWidget, QVBoxLayout, QPushButton,
    QFileDialog, QLabel, QMessageBox
)
from parser import parse_text_file
from converter import export_to_excel


class TextToExcelApp(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Text2Excel Analyzer")
        self.setGeometry(100, 100, 400, 200)

        self.layout = QVBoxLayout()

        self.label = QLabel("–í—ã–±–µ—Ä–∏—Ç–µ .txt —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:")
        self.layout.addWidget(self.label)

        self.open_button = QPushButton("üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤–∏–∫")
        self.open_button.clicked.connect(self.load_file)
        self.layout.addWidget(self.open_button)

        self.convert_button = QPushButton("üì§ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ Excel")
        self.convert_button.clicked.connect(self.convert_file)
        self.convert_button.setEnabled(False)
        self.layout.addWidget(self.convert_button)

        self.setLayout(self.layout)

        self.input_path = None

    def load_file(self):
        path, _ = QFileDialog.getOpenFileName(self, "–í—ã–±–µ—Ä–∏ —Ç–µ–∫—Å—Ç–æ–≤–∏–∫", "", "Text Files (*.txt)")
        if path:
            self.input_path = path
            self.label.setText(f"–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: {path}")
            self.convert_button.setEnabled(True)

    def convert_file(self):
        try:
            data = parse_text_file(self.input_path)

            output_path, _ = QFileDialog.getSaveFileName(self, "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫", "", "Excel Files (*.xlsx)")
            if output_path:
                export_to_excel(data, output_path)
                QMessageBox.information(self, "–£—Å–ø–µ—Ö", "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
        except Exception as e:
            QMessageBox.critical(self, "–û—à–∏–±–∫–∞", f"–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫: {e}")


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = TextToExcelApp()
    window.show()
    sys.exit(app.exec())
